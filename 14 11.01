// Program.cs –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è 5.2
using ApiServicesLibrary;

class Program
{
    static async Task Main(string[] args)
    {
        Console.WriteLine("=== –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–î–ê–ù–ò–Ø 5.2 ===");
        Console.WriteLine("–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è\n");
        
        using var httpClient = new HttpClient();
        var filmService = new FilmServiceAuto(httpClient);
        
        await TestFilmServiceAuto(filmService);
        
        Console.WriteLine("\n–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...");
        Console.ReadLine();
    }
    
    static async Task TestFilmServiceAuto(FilmServiceAuto service)
    {
        try
        {
            // 1. –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–∏–ª—å–º–æ–≤
            Console.WriteLine("1. –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–∏–ª—å–º–æ–≤:");
            var allFilms = await service.GetAllFilmsAsync();
            Console.WriteLine($"‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω–æ —Ñ–∏–ª—å–º–æ–≤: {allFilms?.Count ?? 0}");
            
            // 2. –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ–∏–ª—å–º–∞
            Console.WriteLine("\n2. –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ–∏–ª—å–º–∞:");
            if (allFilms?.Count > 0)
            {
                var firstFilm = await service.GetFilmByIdAsync(allFilms[0].Id);
                Console.WriteLine($"‚úÖ –ù–∞–π–¥–µ–Ω —Ñ–∏–ª—å–º: '{firstFilm?.Title}' —Ä–µ–∂–∏—Å—Å–µ—Ä–∞ '{firstFilm?.Director}'");
            }
            else
            {
                Console.WriteLine("‚ÑπÔ∏è –ù–µ—Ç —Ñ–∏–ª—å–º–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ ID");
            }
            
            // 3. –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ñ–∏–ª—å–º–∞
            Console.WriteLine("\n3. –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ñ–∏–ª—å–º–∞:");
            var newFilm = new Film 
            { 
                Title = "–ò–Ω—Ç–µ—Ä—Å—Ç–µ–ª–ª–∞—Ä", 
                Director = "–ö—Ä–∏—Å—Ç–æ—Ñ–µ—Ä –ù–æ–ª–∞–Ω", 
                Duration = 169,
                GenreId = 1
            };
            
            var createdFilm = await service.CreateFilmAsync(newFilm);
            Console.WriteLine($"‚úÖ –°–æ–∑–¥–∞–Ω —Ñ–∏–ª—å–º —Å ID: {createdFilm.Id}");
            Console.WriteLine($"   –ù–∞–∑–≤–∞–Ω–∏–µ: {createdFilm.Title}");
            Console.WriteLine($"   –†–µ–∂–∏—Å—Å–µ—Ä: {createdFilm.Director}");
            Console.WriteLine($"   –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {createdFilm.Duration} –º–∏–Ω");
            
            // 4. –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å–º–∞
            Console.WriteLine("\n4. –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å–º–∞:");
            if (createdFilm != null)
            {
                createdFilm.Duration = 170;
                await service.UpdateFilmAsync(createdFilm.Id, createdFilm);
                Console.WriteLine($"‚úÖ –§–∏–ª—å–º —Å ID {createdFilm.Id} —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω");
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                var updatedFilm = await service.GetFilmByIdAsync(createdFilm.Id);
                Console.WriteLine($"   –ù–æ–≤–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {updatedFilm?.Duration} –º–∏–Ω");
            }
            
            // 5. –¢–µ—Å—Ç —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∏–ª—å–º–∞
            Console.WriteLine("\n5. –¢–µ—Å—Ç —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∏–ª—å–º–∞:");
            if (createdFilm != null)
            {
                await service.DeleteFilmAsync(createdFilm.Id);
                Console.WriteLine($"‚úÖ –§–∏–ª—å–º —Å ID {createdFilm.Id} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω");
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∏–ª—å–º —É–¥–∞–ª–µ–Ω
                try
                {
                    var deletedFilm = await service.GetFilmByIdAsync(createdFilm.Id);
                    Console.WriteLine("‚ùå –û—à–∏–±–∫–∞: —Ñ–∏–ª—å–º –Ω–µ –±—ã–ª —É–¥–∞–ª–µ–Ω");
                }
                catch (HttpRequestException ex) when (ex.Message.Contains("404"))
                {
                    Console.WriteLine("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: —Ñ–∏–ª—å–º –±–æ–ª—å—à–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (404)");
                }
            }
            
            Console.WriteLine("\nüéâ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–¥–∞–Ω–∏—è 5.2 –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: {ex.Message}");
            if (ex.InnerException != null)
            {
                Console.WriteLine($"   –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞: {ex.InnerException.Message}");
            }
        }
    }
}
