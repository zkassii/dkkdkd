Распишу строго по заданиям лабораторной работы №15 на основе предоставленной схемы базы данных.

Задание 1: Регистрация пользователя

1.1 Модели данных

```csharp
// Models/CinemaUser.cs
public class CinemaUser
{
    public int Id { get; set; }
    public string Login { get; set; } = string.Empty;
    public string PasswordHash { get; set; } = string.Empty;
    public int IncorrectAttemptCount { get; set; } = 0;
    public DateTime? UnblockDate { get; set; }
    public int RoleId { get; set; }
    public CinemaUserRole Role { get; set; } = null!;
}

// Models/CinemaUserRole.cs
public class CinemaUserRole
{
    public int Id { get; set; }
    public string Name { get; set; } = string.Empty;
    public List<CinemaUser> Users { get; set; } = new();
}
```

1.2 DTO для регистрации

```csharp
// DTO/RegisterRequest.cs
public class RegisterRequest
{
    public string Login { get; set; } = string.Empty;
    public string Password { get; set; } = string.Empty;
}
```

1.3 Сервис регистрации

```csharp
// Services/IAuthService.cs
public interface IAuthService
{
    Task<CinemaUser?> RegisterAsync(string login, string password);
    Task<bool> UserExistsAsync(string login);
}

// Services/AuthService.cs
public class AuthService : IAuthService
{
    private readonly CinemaDbContext _context;

    public AuthService(CinemaDbContext context)
    {
        _context = context;
    }

    public async Task<CinemaUser?> RegisterAsync(string login, string password)
    {
        // Проверка существования пользователя
        if (await UserExistsAsync(login))
            return null;

        // Хэширование пароля
        string passwordHash = BCrypt.Net.BCrypt.HashPassword(password);

        // Создание пользователя с ролью "User" (Id = 3) по умолчанию
        var user = new CinemaUser
        {
            Login = login,
            PasswordHash = passwordHash,
            RoleId = 3, // Роль "User" по умолчанию
            IncorrectAttemptCount = 0,
            UnblockDate = null
        };

        _context.CinemaUsers.Add(user);
        await _context.SaveChangesAsync();

        // Загрузка связанных данных
        await _context.Entry(user)
            .Reference(u => u.Role)
            .LoadAsync();

        return user;
    }

    public async Task<bool> UserExistsAsync(string login)
    {
        return await _context.CinemaUsers.AnyAsync(u => u.Login == login);
    }
}
```

1.4 Контроллер регистрации

```csharp
// Controllers/AuthController.cs
[ApiController]
[Route("api/[controller]")]
public class AuthController : ControllerBase
{
    private readonly IAuthService _authService;

    public AuthController(IAuthService authService)
    {
        _authService = authService;
    }

    [HttpPost("register")]
    public async Task<IActionResult> Register([FromBody] RegisterRequest request)
    {
        // Валидация
        if (string.IsNullOrWhiteSpace(request.Login) || string.IsNullOrWhiteSpace(request.Password))
            return BadRequest("Login and password are required");

        if (request.Login.Length < 3)
            return BadRequest("Login must be at least 3 characters");

        if (request.Password.Length < 6)
            return BadRequest("Password must be at least 6 characters");

        // Регистрация
        var user = await _authService.RegisterAsync(request.Login, request.Password);

        if (user == null)
            return Conflict("User with this login already exists");

        return Ok(new 
        { 
            message = "User registered successfully",
            user = new 
            {
                id = user.Id,
                login = user.Login,
                role = user.Role.Name
            }
        });
    }
}
```

Задание 2: Аутентификация пользователя

2.1 DTO для аутентификации

```csharp
// DTO/LoginRequest.cs
public class LoginRequest
{
    public string Login { get; set; } = string.Empty;
    public string Password { get; set; } = string.Empty;
}
```

2.2 Метод аутентификации в сервисе

```csharp
// Services/AuthService.cs
public async Task<CinemaUser?> AuthenticateAsync(string login, string password)
{
    var user = await _context.CinemaUsers
        .Include(u => u.Role)
        .FirstOrDefaultAsync(u => u.Login == login);

    if (user == null)
        return null;

    // Проверка блокировки
    if (user.UnblockDate.HasValue && user.UnblockDate > DateTime.Now)
        throw new Exception("Account is temporarily blocked");

    // Проверка пароля
    bool isPasswordValid = BCrypt.Net.BCrypt.Verify(password, user.PasswordHash);

    if (isPasswordValid)
    {
        // Сброс счетчика при успешной аутентификации
        if (user.IncorrectAttemptCount > 0)
        {
            await ResetIncorrectAttemptsAsync(user.Id);
        }
        return user;
    }
    else
    {
        // Увеличение счетчика неверных попыток
        await IncrementIncorrectAttemptsAsync(user.Id);
        
        // Блокировка при превышении лимита (3 попытки)
        if (user.IncorrectAttemptCount >= 3)
        {
            await BlockUserAsync(user.Id, DateTime.Now.AddMinutes(30));
            throw new Exception("Account blocked for 30 minutes due to too many incorrect attempts");
        }
        
        return null;
    }
}

private async Task BlockUserAsync(int userId, DateTime unblockDate)
{
    var user = await _context.CinemaUsers.FindAsync(userId);
    if (user != null)
    {
        user.UnblockDate = unblockDate;
        await _context.SaveChangesAsync();
    }
}

private async Task ResetIncorrectAttemptsAsync(int userId)
{
    var user = await _context.CinemaUsers.FindAsync(userId);
    if (user != null)
    {
        user.IncorrectAttemptCount = 0;
        user.UnblockDate = null;
        await _context.SaveChangesAsync();
    }
}

private async Task IncrementIncorrectAttemptsAsync(int userId)
{
    var user = await _context.CinemaUsers.FindAsync(userId);
    if (user != null)
    {
        user.IncorrectAttemptCount++;
        await _context.SaveChangesAsync();
    }
}
```

2.3 Метод входа в контроллере

```csharp
// Controllers/AuthController.cs
[HttpPost("login")]
public async Task<IActionResult> Login([FromBody] LoginRequest request)
{
    try
    {
        var user = await _authService.AuthenticateAsync(request.Login, request.Password);

        if (user == null)
            return Unauthorized("Invalid login or password");

        return Ok(new 
        {
            message = "Login successful",
            user = new 
            {
                id = user.Id,
                login = user.Login,
                role = user.Role.Name,
                incorrectAttemptCount = user.IncorrectAttemptCount,
                isBlocked = user.UnblockDate.HasValue && user.UnblockDate > DateTime.Now
            }
        });
    }
    catch (Exception ex)
    {
        return BadRequest(new { message = ex.Message });
    }
}
```

Задание 3: Управление привилегиями

3.1 Модели привилегий

```csharp
// Models/CinemaPrivilege.cs
public class CinemaPrivilege
{
    public int Id { get; set; }
    public string Title { get; set; } = string.Empty;
    public List<CinemaRolePrivilege> RolePrivileges { get; set; } = new();
}

// Models/CinemaRolePrivilege.cs
public class CinemaRolePrivilege
{
    public int PrivilegeId { get; set; }
    public CinemaPrivilege Privilege { get; set; } = null!;
    public int RoleId { get; set; }
    public CinemaUserRole Role { get; set; } = null!;
}
```

3.2 Сервис для работы с привилегиями

```csharp
// Services/IPrivilegeService.cs
public interface IPrivilegeService
{
    Task<List<string>> GetUserPrivilegesAsync(int userId);
    Task<bool> HasPrivilegeAsync(int userId, string privilegeTitle);
}

// Services/PrivilegeService.cs
public class PrivilegeService : IPrivilegeService
{
    private readonly CinemaDbContext _context;

    public PrivilegeService(CinemaDbContext context)
    {
        _context = context;
    }

    public async Task<List<string>> GetUserPrivilegesAsync(int userId)
    {
        return await _context.CinemaUsers
            .Where(u => u.Id == userId)
            .SelectMany(u => u.Role.RolePrivileges)
            .Select(rp => rp.Privilege.Title)
            .Distinct()
            .ToListAsync();
    }

    public async Task<bool> HasPrivilegeAsync(int userId, string privilegeTitle)
    {
        return await _context.CinemaUsers
            .Where(u => u.Id == userId)
            .SelectMany(u => u.Role.RolePrivileges)
            .AnyAsync(rp => rp.Privilege.Title == privilegeTitle);
    }
}
```

Задание 4: Контекст базы данных

4.1 Конфигурация DbContext

```csharp
// Data/CinemaDbContext.cs
public class CinemaDbContext : DbContext
{
    public CinemaDbContext(DbContextOptions<CinemaDbContext> options) : base(options) { }

    public DbSet<CinemaUser> CinemaUsers { get; set; }
    public DbSet<CinemaUserRole> CinemaUserRoles { get; set; }
    public DbSet<CinemaPrivilege> CinemaPrivileges { get; set; }
    public DbSet<CinemaRolePrivilege> CinemaRolePrivileges { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        // Конфигурация CinemaUser
        modelBuilder.Entity<CinemaUser>(entity =>
        {
            entity.ToTable("CinemaUser");
            entity.HasKey(e => e.Id);
            
            entity.Property(e => e.Login)
                .IsRequired()
                .HasMaxLength(50);
                
            entity.Property(e => e.PasswordHash)
                .IsRequired()
                .HasMaxLength(255);
                
            entity.Property(e => e.IncorrectAttemptCount)
                .HasDefaultValue(0);
                
            entity.HasOne(e => e.Role)
                .WithMany(r => r.Users)
                .HasForeignKey(e => e.RoleId);
        });

        // Конфигурация CinemaUserRole
        modelBuilder.Entity<CinemaUserRole>(entity =>
        {
            entity.ToTable("CinemaUserRole");
            entity.HasKey(e => e.Id);
            
            entity.Property(e => e.Name)
                .IsRequired()
                .HasMaxLength(20);
        });

        // Конфигурация CinemaPrivilege
        modelBuilder.Entity<CinemaPrivilege>(entity =>
        {
            entity.ToTable("CinemaPrivilege");
            entity.HasKey(e => e.Id);
            
            entity.Property(e => e.Title)
                .IsRequired()
                .HasMaxLength(100);
        });

        // Конфигурация CinemaRolePrivilege
        modelBuilder.Entity<CinemaRolePrivilege>(entity =>
        {
            entity.ToTable("CinemaRolePrivilege");
            entity.HasKey(e => new { e.PrivilegeId, e.RoleId });
        });

        // Начальные данные
        SeedData(modelBuilder);
    }

    private void SeedData(ModelBuilder modelBuilder)
    {
        // Роли
        modelBuilder.Entity<CinemaUserRole>().HasData(
            new CinemaUserRole { Id = 1, Name = "Admin" },
            new CinemaUserRole { Id = 2, Name = "Manager" },
            new CinemaUserRole { Id = 3, Name = "User" }
        );

        // Привилегии
        modelBuilder.Entity<CinemaPrivilege>().HasData(
            new CinemaPrivilege { Id = 1, Title = "ViewFilms" },
            new CinemaPrivilege { Id = 2, Title = "BookTickets" },
            new CinemaPrivilege { Id = 3, Title = "ManageFilms" },
            new CinemaPrivilege { Id = 4, Title = "ManageUsers" },
            new CinemaPrivilege { Id = 5, Title = "ViewReports" }
        );

        // Связи ролей и привилегий
        modelBuilder.Entity<CinemaRolePrivilege>().HasData(
            // Admin - все привилегии
            new CinemaRolePrivilege { RoleId = 1, PrivilegeId = 1 },
            new CinemaRolePrivilege { RoleId = 1, PrivilegeId = 2 },
            new CinemaRolePrivilege { RoleId = 1, PrivilegeId = 3 },
            new CinemaRolePrivilege { RoleId = 1, PrivilegeId = 4 },
            new CinemaRolePrivilege { RoleId = 1, PrivilegeId = 5 },
            
            // User - базовые привилегии
            new CinemaRolePrivilege { RoleId = 3, PrivilegeId = 1 },
            new CinemaRolePrivilege { RoleId = 3, PrivilegeId = 2 }
        );
    }
}
```

Задание 5: Конфигурация приложения

5.1 Program.cs

```csharp
var builder = WebApplication.CreateBuilder(args);

// Сервисы
builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// База данных
builder.Services.AddDbContext<CinemaDbContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));

// Сервисы приложения
builder.Services.AddScoped<IAuthService, AuthService>();
builder.Services.AddScoped<IPrivilegeService, PrivilegeService>();

var app = builder.Build();

// Конвейер middleware
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();
app.UseAuthorization();
app.MapControllers();

app.Run();
```

5.2 appsettings.json

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=(localdb)\\mssqllocaldb;Database=CinemaAuthDb;Trusted_Connection=true;MultipleActiveResultSets=true"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}
```

Задание 6: Миграции и тестирование

6.1 Создание миграций

```bash
# Установка инструментов EF
dotnet tool install --global dotnet-ef

# Создание миграции
dotnet ef migrations add InitialCreate

# Применение миграции
dotnet ef database update
```

6.2 Тестирование в Postman

Регистрация пользователя:

```http
POST /api/auth/register
Content-Type: application/json

{
  "login": "testuser",
  "password": "password123"
}
```

Аутентификация пользователя:

```http
POST /api/auth/login
Content-Type: application/json

{
  "login": "testuser",
  "password": "password123"
}
```

Получение привилегий пользователя:

```http
GET /api/privileges/{userId}
```

Это полная реализация лабораторной работы №15 с системой аутентификации и управления доступом на основе ролей и привилегий.
